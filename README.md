##  汇编小组作业中期汇报文档

### 0.基本介绍

基于黄金矿工游戏以及抓娃娃机开发类黄金矿工小游戏。

进入初始界面，按 `Ctrl` 键即可显示规则，双击屏幕即可开始游戏。

游戏界面上方会显示已获得的分数、剩余时间以及道具数量。

进入游戏界面后左键点击即可使矿工停下出勾，出勾后需等待至钩子返回才可以继续操作。

出钩会检测是否抓到物体，如果抓到物体立即返回，返回速度与物体大小成正比。如果没有检测到物体则钩子触底后自动返回。

物体分为钻石、金块、石块、TNT 和神秘包裹。金块价值比石块更高。钻石价值最高但很难抓取。TNT 触碰到后会直接爆炸使游戏失败。神秘包裹包含四种可能的道具，分别为石头收藏书、大力丸、加速药以及炸药。

四种道具均为一次性，按下 1、2、3、4 即可使用，且效果仅在本关有效。

石头收藏书使用后会使得下三次抓到的石头价值变高，大力丸会使得抓钩抓到物体后的返回速度变高，加速药会使得人物的移动速度变快，炸药使用后可以炸掉当前抓到的物体。

四种道具的效果不会叠加，如一关内使用两个大力丸并不会使抓钩返回速度变得比使用一个的时候更快。

每一关目标分数均为 $(600 \times 关卡数 +300)$  分，限时 60s 内达到，如果成功自动进入下一关，如果限时结束且未达到分数则失败，自动返回初始界面。游戏目标是通过尽可能多的关卡。

### 1.开发环境

使用 `Visual Studio` ，在课程要求的 `masm` + `Irvine` 汇编环境下开发。

### 2.实现原理

基于课程提供的 `WinAPP_v2.asm` 窗口文件进行开发。

首先添加各类资源文件，主要为 `bitmap` 文件、`ico` 文件、`wav` 文件，包括背景图、矿工图、钩子图、金块图、包裹图、石块图以及音效文件。

##### data

在 `data` 部分创建了 `Item` 结构体用于储存被勾的物体，包含 `exist` 变量（储存是否还存在）、`type` 变量（储存种类）、`posX` 变量（储存横坐标）、`posY` 变量（储存纵坐标）、`item_width`（储存尺寸）、`speed`（储存上升速度）、`value`（储存价值）。
此外还定义了物体数量、钩子相关参数、格式 `icon` 变量以及是否碰撞、运动方向等的标志。
中期之后新增了标志初始界面/游戏界面的变量、记录道具数量的变量、提示语句以及其缓冲区、标志是否使用了对应道具的变量。

##### code

在 `code` 部分中定义 `AddStoneItem` 、`AddBagItem` 等函数用于添加新物体存放五种物体在 `Item` 数组内，参数为 `posx`，`posy` 以及 `itemwidth`。再定义 `getPosX` 以及 `getPosY` 函数用于获取位置。

定义 `ExistNoLonger` 函数更新物体的存在状态，当钩子抓上物体之后更新标志，`IsHit` 函数进行碰撞检测。
中期后新增定义了 `BombedOut` 函数用于处理炸药导致的物体消失；新增 `RandomBag` 函数用于随机得到包裹的道具，每种各有 `1/4` 概率。

在 `WinProc` 函数中的 `WM_LBUTTONDOWN` 分支中根据 `isLeftClick` 的值来更新状态，进行判断是否开始计时器以及是否进行钩子的运动。新增根据 `startPage` 变量判断是否为初始界面并更改该变量实现界面跳转。

`WM_CREATE` 分支中进行 `LoadIcon` 载入 `ico` 资源文件，新增判断键盘输入，如果按下 1、2、3、4 则在游戏中使用道具，如果为`Ctrl` 则可以在初始界面显示规则。

`WM_TIMER` 分支中设置矿工以及钩子移动的定时器。该分支中实现了各种运动的逻辑和边界判断。新增实现游戏时间的倒计时，并根据分数与剩余时间来判断是否进入成功界面与失败界面。

`WM_PAINT` 分支中开始绘图，先调用 `BeginPaint` ，再用 `DrawIcon` 和 `DrawBitMap` 对背景、矿工、钩子以及各个物体进行绘图。背景一直最先绘制，这样可以使它位于图层底部。矿工和钩子按照计时器绘制，受鼠标点击影响。其他物体先取随机位置，其后在未被抓取到时按照原位置绘图，被抓取到后跟随钩子位置绘制。新增根据 `startPage` 值来判断是否进行初始界面的绘画，根据 `successPage` 和 `failPage` 值来判断过关成功或失败的页面，根据以及使用 `sndPlaySound` 来进行音效播放。

###  3.难点和创新点

1.实现背景贴图以及物体的随机位置贴图。
2.实现指定范围内矿工、钩子的来回移动以及点击控制。
3.实现物体与抓钩的碰撞检测以及抓取速度、物体价值与物体大小的关系。
4.实现根据抓取物体的价值更新点数
5.实现道具的随机获取。
6.实现分数、倒计时与过关逻辑。
7.实现音效

###  4.小组分工

刘子张 负责基础贴图，更新分数，随机位置生成，随机道具获取，音效，页面跳转
王晋赟 负责固定范围内移动，鼠标点击后停止/开始移动，道具效果
樊臣焱 负责维护物体数组，碰撞检测，物体抓取效果，过关成功与失败

### 5.与中期相比的进展

如以上部分所示，主要完善了整体的游戏流程和逻辑，实现了根据分数与倒计时来进行关卡迁移，加入了道具的获取、使用以及销毁全过程。同时新增两种物体，加入了初始界面的背景、规则、过关成功与失败页面以及音效等。

P.S.压缩包的 `mov` 目录下有游戏的演示视频。